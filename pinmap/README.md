The files in this directory relate to maintaining the mapping between
pins on the microzed headers, pads on the Zynq SOC, and signal name in
Kicad.

See pin_order.txt in this directory for notes on the main board pin mapping plan.

See notebook.txt [1-4 June 20] for more discussion.

gen_mapping.m is a Matlab script that processes input files:
* `microzed_pinout.xlsx`: basic fixed mapping and description of MicroZed pins.
* `microzed_mapping.csv`: mapping of PL IO pins to Kicad symbol pins.

to generate output files:
* `kipart_microzed.csv`: the input to kipart, see below.
* `kipart_microzed_annotated.csv`: same as `kipart_microzed.csv` except that it has additional documentation columns copied from `microzed_pinout.xlsx`, and lacks the kipart header line (which violates csv convention).
* <vivado constraints file TBD>


## microzed_pinout.xlsx:
Mostly fixed information about every pin on the MicroZed.  This is in particular used to keep track of the relation between the MicroZen pin and the Zynq pinout pad code.  For dedicated pins such as power, initialization, etc., the Kicad symbol info (Unit, Side, Type) is also kept here.  Since this represents *all* pins, there are always 200 lines representing every pin number.  All the remappable PL IO pins are in the "unused" unit.

## microzed_mapping.csv:
This file defines the mapping for the re-mappable PL IO pins.  This overrides the (Unit, Side, Type) info in microzed_pinout.xslx, and uses a format that avoids redundancies that could become inconsistent, and splits out the out the (JX, Type, Line) info that is encoded into the MicroZed_Name so that it can be easily modified as a spreadheet.

The 'Unit', 'Side', and 'Type' fields are directly copied into 'kipart_pinmap.csv', and define which Kicad unit (eg. gate equivalent) the pins belong to, which side of the box symbol the pin goes on, and the Kicad electrical type.  For single-ended signals the 'Name' is also directly copied into 'kipart_pinmap.csv'.  If the signal is differential then two pins are generated, with names '+' and '-' suffix, see 'Sense' below.  

The MicroZed PL IO names have been constructed (by Avnet) with the format:
    <JX*n*>_<*Pairing*>_<*Line*>_{N,P}
If *Pairing* is 'SE' then there is no trailing '_N' or '_P'.

These fields should be understood as forming the full MicroZed_Name in `microzed_pinout.xlsx`.  
* JX: the MicroZed JX jack number, 1 or 2.
* Pairing: SE or LVDS.  This is simply part of the name, pins in an LVDS pair may be used as single-ended. SE pins can only be used as single-ended.
* Line: decimal number selecting a SE line or LVDS pair. The line numbers are repeated between SE and LVDS and between JX1 and JX2.

The 'Sense' field indirectly encodes the '_N' or '_P'.  Values are:
* 'SE': a single-ended line used as single-ended.
* 'SE_P': the 'P' line of a diff pair used as single-ended.
* 'SE_N': the 'N' line of a diff pair used as single-ended.
* 'DIFF': a LVDS differential pair. Two pin mappings are generated, one for 'P' and one for 'N'. The two Kicad pin names are generated by appending '+' and '-' to the name.

These are sort keys which can be used to sort the rows by either schematic symbol pin or Microzed pin.  Sorting into the microzed ordering makes it easier to allocate sequential pins using spreadsheet fill.  gen_mapping.m currently ignores these fields, so you need to leave the file sorted by UNum, UOrder to get the right symbol output.
* 'UNum': The schematic symbol unit number, determines the unit ordering.
* 'UOrder': The pin ordering in the unit.
* 'LNum': The hardware line group, in left-to-right order on the connector. Line groups do not have to be the same as the symbol unit (pins in multiple units can map to a single line group, or vice-versa).  This grouping helps us allocate pins in functional chunks.
* 'LOrder': The ordering within the line group, left to right.


## Kipart:
kipart is a python program for generating Kicad schematic symbols from CSV files.  This is used to generate the symbols for the Microzed.  See Kipart documentation for a full explanation of the output fields.


If you have Python installed you can use:
    pip install kipart
to install and:
    pip install --upgrade
to update your installed version.

I run kipart via the anaconda shell under windows.  cd to 'ilemt_hw\pinmap' before running kipart.

Kicad is not entirely happy with symbols being redefined after they have been placed on the Schematic.  Exit Kicad before generating a new symbol library:
    kipart -b -w kipart_microzed.csv

'-b' means create a single pin for a bundle pins with the same name (usually power).  '-w' allows overwriting.

This generates kipart_microzed.lib, which should be included in the Kicad symbol path (using Preferences/Manage Symbol Paths)

Restart Kicad.  It will likely offer to "rescue" the old symbols, but don't! This copies the old symbols from the library cache into a new "rescue" library, so the schematic continues to reference the old symbols.  This is quite bad because you now have references to the wrong symbols (with wrong pin mapping).  Just restart Kicad, and decline to rescue.  If Kicad is running when you change the library, and it notices (such as when you place a new unit) it will show all of the references to the old symbol as "broken".  Just restart.  Maybe if a symbol is truly broken then you will have to re-place and re-wire it, IDK.


